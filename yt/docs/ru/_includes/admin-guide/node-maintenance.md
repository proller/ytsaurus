## Администрирование нод

В данном разделе собрано описание некоторых возможностей администрирования кластерных нод.

### Pending restart

Основной сценарий использования данного флага - оптимизация репликационной работы мастера при проведении обслуживания кластерных data-нод, предполагающая их кратковременное нефункционирование. Так, перед началом таких работ рекомендуется выполнить следующее действие:

```bash
$ yt add-maintenance --component="cluster_node" --type="pending_restart" --address="my-node.yandex.net"  --comment="my comment"
```

Убедиться что нода стала _restart pending_ можно следующей командой
```bash
$ yt get //sys/cluster_nodes/my-node.yandex.net/@pending_restart
> true
```

#### Описание работы

Когда объект-нода стала _restart pending_, таймаут ее _lease_-транзакции будет значительно увеличен. Это означает, что нода в течение длительного промежутка времени будет считаться _online_ даже после того, как фактически прекратит периодическими запросами к мастер-серверу подтверждать свою доступность. Время такого промежутка настраивается в динамическом конфиге мастера по пути `//sys/@config/node_tracker/pending_restart_lease_timeout` (по умолчанию - 10 минут).

Заявленная оптимизация работы репликатора чанков на мастере достигается особенной обработкой реплик, находящихся на нодах с подобным флагом, далее именуемых _temporarily unavailable_ репликами. Реплики, находящиеся на обычных нодах, будем называть _available_ репликами.

Так, чанк обычного формата считается _underreplicated_, если выполняется одно из условий:
* совокупное число реплик _available_ + _temporarily unavailable_ меньше _replication factor_;
* _active_ реплик меньше, чем 1 + _max replicas per rack_;
* _temporaily unavailable_ реплик больше одной;

В свою очередь, _erasure_ чанки считаются _parity missing_ или _data missing_, если
* какая-то из реплик недоступна и не является _temporarily unavailable_;
* разница между минимальным необходимым числом реплик, когда чанк еще возможно восстановить, и числом _temporarily unavailable_ реплик меньше, чем _max erasure replicas per rack_;

В типичном случае конфигурации кластера с _replication factor = 3_ и _max replicas per rack = 1_, практическое использование _pending restart_ предполагает одновременную работу с нодами только внутри одной стойки.

#### Завершение работы

Флаг _pending restart_ снимется при перезапуске ноды, а именно в момент ее перерегистрации на мастере. Также флаг можно снять явно

```bash
$ yt remove-maintenance --component="cluster_node" --address="my-node.yandex.net" --id="<maintenance-id>"
```

Длительное использование данного флага опасно, поэтому время его действия сознательно ограничено конфигурируемым интервалом - уже известным `pending_restart_lease_timeout`, по истечении которого флаг будет снят автоматически. Дедлайн отсчитывается с момента последнего взведения флага.
